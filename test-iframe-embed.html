<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Trainer - Iframe Embedding Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .embed-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .embed-section h2 {
            margin-top: 0;
            color: #555;
        }
        .iframe-wrapper {
            margin: 20px 0;
            text-align: center;
        }
        .controls {
            margin: 20px 0;
        }
        .controls button {
            margin: 5px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #0056b3;
        }
        .controls input {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        .config-form {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .config-form label {
            text-align: right;
            font-weight: bold;
        }
        iframe {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>Chess Trainer - Iframe Embedding Test</h1>
    
    <div class="container">
        <div class="embed-section">
            <h2>Configuration</h2>
            <form class="config-form" id="configForm">
                <label for="gameId">Game ID:</label>
                <input type="text" id="gameId" value="test_game_123" />
                
                <label for="mode">Mode:</label>
                <select id="mode">
                    <option value="minimal">Minimal</option>
                    <option value="board-only">Board Only</option>
                    <option value="full">Full</option>
                </select>
                
                <label for="width">Width:</label>
                <input type="number" id="width" value="600" min="300" max="1200" />
                
                <label for="height">Height:</label>
                <input type="number" id="height" value="600" min="300" max="1200" />
                
                <label for="allowMoves">Allow Moves:</label>
                <input type="checkbox" id="allowMoves" checked />
                
                <label for="showControls">Show Controls:</label>
                <input type="checkbox" id="showControls" />
            </form>
            
            <div class="controls">
                <button onclick="createEmbed()">Create/Update Embed</button>
                <button onclick="getEmbedUrl()">Get Embed URL (MCP)</button>
            </div>
            
            <h3>Parent Controls</h3>
            <div class="controls">
                <button onclick="sendCommand('reset')">Reset Game</button>
                <button onclick="sendCommand('flip')">Flip Board</button>
                <button onclick="sendMove()">Make Move e2e4</button>
                <button onclick="loadFen()">Load Custom Position</button>
            </div>
            
            <h3>Event Log</h3>
            <div class="log" id="eventLog"></div>
        </div>
        
        <div class="embed-section">
            <h2>Embedded Chess Board</h2>
            <div class="iframe-wrapper" id="iframeWrapper">
                <p>Click "Create/Update Embed" to load the chess board</p>
            </div>
            
            <h3>Generated Embed Code</h3>
            <pre class="log" id="embedCode"></pre>
        </div>
    </div>

    <script>
        let iframe = null;
        
        // Log events
        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
        
        // Create or update embed
        function createEmbed() {
            const gameId = document.getElementById('gameId').value;
            const mode = document.getElementById('mode').value;
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const allowMoves = document.getElementById('allowMoves').checked;
            const showControls = document.getElementById('showControls').checked;
            
            const embedUrl = `http://localhost:3456/embed?game_id=${gameId}&mode=${mode}&width=${width}&height=${height}&allow_moves=${allowMoves}&show_controls=${showControls}`;
            
            const iframeHtml = `<iframe 
    src="${embedUrl}"
    width="${width}"
    height="${height}"
    frameborder="0"
    allow="fullscreen"
    style="border: 1px solid #ccc; border-radius: 8px;"
></iframe>`;
            
            // Update iframe
            const wrapper = document.getElementById('iframeWrapper');
            wrapper.innerHTML = iframeHtml;
            iframe = wrapper.querySelector('iframe');
            
            // Update embed code display
            document.getElementById('embedCode').textContent = iframeHtml;
            
            logEvent('Embed created/updated');
        }
        
        // Get embed URL via MCP (simulated)
        async function getEmbedUrl() {
            const gameId = document.getElementById('gameId').value;
            const mode = document.getElementById('mode').value;
            const width = parseInt(document.getElementById('width').value);
            const height = parseInt(document.getElementById('height').value);
            const allowMoves = document.getElementById('allowMoves').checked;
            const showControls = document.getElementById('showControls').checked;
            
            // Simulate MCP call
            const mcpRequest = {
                method: 'tools/call',
                params: {
                    name: 'get_embeddable_url',
                    arguments: {
                        game_id: gameId,
                        mode: mode,
                        width: width,
                        height: height,
                        allow_moves: allowMoves,
                        show_controls: showControls
                    }
                }
            };
            
            logEvent(`MCP Request: ${JSON.stringify(mcpRequest.params.arguments)}`);
            
            // Show what the MCP response would be
            const embedUrl = `http://localhost:3456/embed?game_id=${gameId}&mode=${mode}&width=${width}&height=${height}&allow_moves=${allowMoves}&show_controls=${showControls}`;
            logEvent(`MCP Response URL: ${embedUrl}`);
        }
        
        // Send command to embedded chess board
        function sendCommand(command) {
            if (!iframe || !iframe.contentWindow) {
                logEvent('Error: No iframe loaded');
                return;
            }
            
            const message = {
                type: 'chess_command',
                command: command
            };
            
            iframe.contentWindow.postMessage(message, '*');
            logEvent(`Sent command: ${command}`);
        }
        
        // Send move command
        function sendMove() {
            if (!iframe || !iframe.contentWindow) {
                logEvent('Error: No iframe loaded');
                return;
            }
            
            const message = {
                type: 'chess_command',
                command: 'move',
                move: 'e2e4',
                san: 'e4'
            };
            
            iframe.contentWindow.postMessage(message, '*');
            logEvent('Sent move: e2e4');
        }
        
        // Load custom FEN position
        function loadFen() {
            if (!iframe || !iframe.contentWindow) {
                logEvent('Error: No iframe loaded');
                return;
            }
            
            // Load a position from the Italian Game
            const fen = 'r1bqkbnr/pppp1ppp/2n5/4p3/2B1P3/5N2/PPPP1PPP/RNBQK2R b KQkq - 3 3';
            
            const message = {
                type: 'chess_command',
                command: 'load_fen',
                fen: fen
            };
            
            iframe.contentWindow.postMessage(message, '*');
            logEvent('Loaded FEN: Italian Game position');
        }
        
        // Listen for messages from embedded chess board
        window.addEventListener('message', (event) => {
            // In production, verify event.origin
            if (event.data.type === 'chess_move') {
                logEvent(`Received move: ${event.data.san} (${event.data.move})`);
            } else if (event.data.type === 'request_hint') {
                logEvent(`Hint requested for position: ${event.data.fen.substring(0, 30)}...`);
            }
        });
        
        // Initialize with default embed on load
        window.addEventListener('load', () => {
            setTimeout(createEmbed, 100);
        });
    </script>
</body>
</html>